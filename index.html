<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Oscillator with Filter Envelope, Resonance, Distortion & Compressor</title>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    button { font-size: 16px; padding: 10px 20px; margin: 10px; cursor: pointer; }
    .slider-container { margin: 10px 0; }
    input[type=range] { width: 300px; }
    .value { display: inline-block; width: 80px; text-align: right; margin-left: 10px; }
    select { font-size: 16px; padding: 5px; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Oscillator with Filter Envelope, Resonance, Distortion & Compressor</h2>

  <button id="start">Start Oscillator</button>
  <button id="stop">Stop Oscillator</button>
  <button id="triggerEnv">Trigger Filter Envelope</button>
  <br>
  <button id="startPattern">Start Pattern</button>
  <button id="stopPattern">Stop Pattern</button>
  <br>
  <!-- Waveform buttons -->
  <button id="waveSaw">Sawtooth Wave</button>
  <button id="waveSquare">Square Wave</button>
  <button id="waveSine">Sine Wave</button>
  <br>
  <!-- Pitch buttons -->
  <button id="noteC1">C1</button>
  <button id="noteC2">C2</button>

  <!-- Attack slider -->
  <div class="slider-container">
    <label>Attack Time (Ramp up):</label>
    <input type="range" id="slider1" min="0" max="0.5" step="0.001" value="0.015">
    <span class="value" id="slider1Value">0.015</span>
  </div>

  <!-- Decay slider -->
  <div class="slider-container">
    <label>Decay Time (Ramp back):</label>
    <input type="range" id="slider2" min="0" max="1" step="0.001" value="0.355">
    <span class="value" id="slider2Value">0.355</span>
  </div>

  <!-- Target cutoff frequency slider -->
  <div class="slider-container">
    <label>Target Cutoff Frequency (Hz):</label>
    <input type="range" id="sliderCutoff" min="100" max="10000" step="1" value="1000">
    <span class="value" id="sliderCutoffValue">1000</span>
  </div>

  <!-- Resonance (Q) slider -->
  <div class="slider-container">
    <label>Filter Resonance (Q):</label>
    <input type="range" id="sliderResonance" min="0" max="10" step="0.1" value="4">
    <span class="value" id="sliderResonanceValue">4.0</span>
  </div>

  <!-- Distortion sliders -->
  <div class="slider-container">
    <label>Distortion Amount:</label>
    <input type="range" id="sliderDist" min="0" max="1" step="0.01" value="0.4">
    <span class="value" id="sliderDistValue">0.40</span>
  </div>

  <div class="slider-container">
    <label>Oversampling:</label>
    <select id="oversampleSelect">
      <option value="none">None</option>
      <option value="2x">2x</option>
      <option value="4x" selected>4x</option>
    </select>
  </div>

  <!-- Amplitude slider -->
  <div class="slider-container">
    <label>Amplitude:</label>
    <input type="range" id="sliderAmp" min="0" max="1" step="0.01" value="0.5">
    <span class="value" id="sliderAmpValue">0.50</span>
  </div>

  <!-- === Compressor Sliders === -->
  <h3>Compressor Controls</h3>
  <div class="slider-container">
    <label>Threshold (dB):</label>
    <input type="range" id="compThreshold" min="-60" max="0" step="1" value="-28">
    <span class="value" id="compThresholdValue">-28</span>
  </div>

  <div class="slider-container">
    <label>Ratio:</label>
    <input type="range" id="compRatio" min="1" max="20" step="0.1" value="4">
    <span class="value" id="compRatioValue">4.0</span>
  </div>

  <div class="slider-container">
    <label>Attack (s):</label>
    <input type="range" id="compAttack" min="0" max="1" step="0.01" value="0.03">
    <span class="value" id="compAttackValue">0.03</span>
  </div>

  <div class="slider-container">
    <label>Release (s):</label>
    <input type="range" id="compRelease" min="0" max="1" step="0.01" value="0.12">
    <span class="value" id="compReleaseValue">0.12</span>
  </div>

  <div class="slider-container">
    <label>Knee (dB):</label>
    <input type="range" id="compKnee" min="0" max="40" step="1" value="6">
    <span class="value" id="compKneeValue">6</span>
  </div>

  <!-- Compressor Mute/Unmute buttons -->
  <div class="slider-container">
    <button id="muteComp">Mute Compressor</button>
    <button id="unmuteComp">Unmute Compressor</button>
  </div>

  <script>
    function midiToFreq(midiNote) {
      return 440 * Math.pow(2, (midiNote - 69) / 12);
    }

    // === Oscillator & Filter Setup ===
    const osc = new Tone.Oscillator(midiToFreq(36), "sawtooth"); 
    const amp = new Tone.Gain(0.5); 
    const filter = new Tone.Filter({ type: "lowpass", frequency: 0, Q: 4 });

    // === Distortion ===
    const distortion = new Tone.Distortion({
      distortion: 0.4,
      oversample: "4x"
    });

    // === Compressor ===
    const bassComp = new Tone.Compressor({
      threshold: -28,
      ratio: 4,
      attack: 0.03,
      release: 0.12,
      knee: 6
    });

    // Routing: Osc → Amp → Filter → Distortion → Compressor → Speakers
    osc.connect(amp);
    amp.connect(filter);
    filter.connect(distortion);
    distortion.connect(bassComp);
    bassComp.toDestination();

    let isPlaying = false;
    let isCompMuted = false;

    // === Start/Stop Oscillator ===
    document.getElementById("start").addEventListener("click", async () => {
      await Tone.start();
      if (!isPlaying) { osc.start(); isPlaying = true; }
    });

    document.getElementById("stop").addEventListener("click", () => {
      if (isPlaying) { osc.stop(); isPlaying = false; }
    });

    // === Waveform buttons ===
    document.getElementById("waveSaw").addEventListener("click", () => { osc.type = "sawtooth"; });
    document.getElementById("waveSquare").addEventListener("click", () => { osc.type = "square"; });
    document.getElementById("waveSine").addEventListener("click", () => { osc.type = "sine"; });

    // === Pitch buttons ===
    document.getElementById("noteC1").addEventListener("click", () => { osc.frequency.value = midiToFreq(24); });
    document.getElementById("noteC2").addEventListener("click", () => { osc.frequency.value = midiToFreq(36); });

    // === Filter Envelope Sliders ===
    const slider1 = document.getElementById("slider1");
    const slider1Value = document.getElementById("slider1Value");
    const slider2 = document.getElementById("slider2");
    const slider2Value = document.getElementById("slider2Value");
    const sliderCutoff = document.getElementById("sliderCutoff");
    const sliderCutoffValue = document.getElementById("sliderCutoffValue");
    const sliderResonance = document.getElementById("sliderResonance");
    const sliderResonanceValue = document.getElementById("sliderResonanceValue");

    slider1.addEventListener("input", () => { slider1Value.textContent = parseFloat(slider1.value).toFixed(3); });
    slider2.addEventListener("input", () => { slider2Value.textContent = parseFloat(slider2.value).toFixed(3); });
    sliderCutoff.addEventListener("input", () => { sliderCutoffValue.textContent = parseInt(sliderCutoff.value); });
    sliderResonance.addEventListener("input", () => {
      const qValue = parseFloat(sliderResonance.value);
      filter.Q.value = qValue;
      sliderResonanceValue.textContent = qValue.toFixed(1);
    });

    // === Distortion Controls ===
    const sliderDist = document.getElementById("sliderDist");
    const sliderDistValue = document.getElementById("sliderDistValue");
    const oversampleSelect = document.getElementById("oversampleSelect");

    sliderDist.addEventListener("input", () => {
      distortion.distortion = parseFloat(sliderDist.value);
      sliderDistValue.textContent = parseFloat(sliderDist.value).toFixed(2);
    });

    oversampleSelect.addEventListener("change", () => {
      distortion.oversample = oversampleSelect.value;
    });

    // === Amplitude ===
    const sliderAmp = document.getElementById("sliderAmp");
    const sliderAmpValue = document.getElementById("sliderAmpValue");

    sliderAmp.addEventListener("input", () => {
      amp.gain.value = parseFloat(sliderAmp.value);
      sliderAmpValue.textContent = parseFloat(sliderAmp.value).toFixed(2);
    });

    // === Compressor Sliders ===
    document.getElementById("compThreshold").addEventListener("input", (e) => {
      bassComp.threshold.value = parseFloat(e.target.value);
      document.getElementById("compThresholdValue").textContent = e.target.value;
    });

    document.getElementById("compRatio").addEventListener("input", (e) => {
      bassComp.ratio.value = parseFloat(e.target.value);
      document.getElementById("compRatioValue").textContent = e.target.value;
    });

    document.getElementById("compAttack").addEventListener("input", (e) => {
      bassComp.attack = parseFloat(e.target.value);
      document.getElementById("compAttackValue").textContent = e.target.value;
